name: Publish to Github Pages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1,3,5'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        state: ["Rhode Island", "Massachusetts", "Connecticut"]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'

    - name: Install dependencies
      run: npm install axios qs csv-parser csv-writer papaparse

    - name: Run script for ${{ matrix.state }}
      run: node ./us-wikidata_qa.js "${{ matrix.state }}"

    - name: Upload result for ${{ matrix.state }}
      uses: actions/upload-artifact@v3
      with:
        name: output-${{ matrix.state }}
        path: ./output

  combine:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3


    - name: Create combined output directory
      run: mkdir -p combined_output

    - name: Move all files to combined output directory
      run: |
        find . -name '*.csv' -exec mv {} combined_output/ \;

    - name: Upload Combined 🏗
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./combined-output

    - name: Deploy Combined 🚀
      id: deployment
      uses: actions/deploy-pages@v4
